---
import BaseLayout from '../../layouts/BaseLayout.astro';

// Get all pieces from the content/commonplace folder
const pieces = await Astro.glob('../../content/commonplace/*.md');
const sortedPieces = pieces.sort((a, b) =>
  new Date(b.frontmatter.date).getTime() - new Date(a.frontmatter.date).getTime()
);

// Collect all unique tags
const allTags = [...new Set(sortedPieces.flatMap(p => p.frontmatter.tags || []))].sort();
---

<BaseLayout title="Commonplace | Devashish" description="Collected poems, quotes, and fragments">
  <h1>Commonplace</h1>
  <p class="page-intro">Poems, quotes, and fragments I've collectedâ€”words that resonated. The word "commonplace" comes from a <a href="https://en.wikipedia.org/wiki/Commonplace_book" target="_blank" rel="noopener">commonplace notebook</a>.</p>

  {allTags.length > 0 && (
    <nav class="tag-nav">
      {allTags.map((tag) => (
        <a href={`#${tag}`} class="pill" data-tag={tag}>{tag}</a>
      ))}
    </nav>
  )}

  {sortedPieces.length > 0 ? (
    <ul class="piece-list">
      {sortedPieces.map((piece) => (
        <li data-tags={JSON.stringify(piece.frontmatter.tags || [])}>
          <a href={`/commonplace/${piece.frontmatter.slug}`}>
            <span class="piece-title">{piece.frontmatter.title}</span>
            <span class="piece-meta">
              {(piece.frontmatter.tags || []).map((tag: string) => (
                <span class="piece-tag">{tag}</span>
              ))}
              <span class="piece-author">{piece.frontmatter.author}</span>
            </span>
          </a>
        </li>
      ))}
    </ul>
  ) : (
    <div class="placeholder">
      <p>Collection coming soon.</p>
    </div>
  )}
</BaseLayout>

<style>
  .page-intro {
    color: var(--color-text-muted);
    margin-bottom: 2rem;
  }

  .tag-nav {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 2rem;
  }

  .pill {
    font-family: var(--font-heading);
    font-size: 0.85rem;
    color: var(--color-text-muted);
    padding: 0.35rem 0.85rem;
    border: 1px solid var(--color-border);
    border-radius: 100px;
    text-decoration: none;
    transition: all 0.15s ease;
    cursor: pointer;
  }

  .pill:hover {
    color: var(--color-text);
    background-color: var(--color-surface);
    border-color: var(--color-text-muted);
  }

  .pill.active {
    color: var(--color-bg);
    background-color: var(--color-text);
    border-color: var(--color-text);
  }

  .piece-list {
    list-style: none;
    padding: 0;
  }

  .piece-list li {
    margin-bottom: 0;
  }

  .piece-list li.hidden {
    display: none;
  }

  .piece-list a {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 1rem;
    padding: 0.75rem 0.75rem;
    margin: 0 -0.75rem;
    border-radius: 6px;
    transition: background-color 0.15s ease;
  }

  .piece-list a:hover {
    background-color: var(--color-surface);
  }

  .piece-list a:hover .piece-title {
    text-decoration: underline;
    text-underline-offset: 3px;
  }

  .piece-title {
    font-family: var(--font-heading);
  }

  .piece-meta {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
    white-space: nowrap;
  }

  .piece-tag {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    padding: 0.15rem 0.5rem;
    border: 1px solid var(--color-border);
    border-radius: 100px;
  }

  .piece-author {
    font-size: 0.85rem;
    color: var(--color-text-muted);
    font-style: italic;
  }

  .placeholder {
    margin-top: 2rem;
    padding: 2rem;
    background: var(--color-surface);
    border-radius: 6px;
  }

  .placeholder p {
    color: var(--color-text-muted);
    text-align: center;
    margin: 0;
  }
</style>

<script>
  function filterPieces() {
    const hash = window.location.hash.slice(1);
    const items = document.querySelectorAll('.piece-list li');
    const pills = document.querySelectorAll('.tag-nav a');

    pills.forEach(pill => {
      if (pill.dataset.tag === hash) {
        pill.classList.add('active');
      } else {
        pill.classList.remove('active');
      }
    });

    if (hash) {
      items.forEach(item => {
        const tags = JSON.parse(item.dataset.tags || '[]');
        if (tags.includes(hash)) {
          item.classList.remove('hidden');
        } else {
          item.classList.add('hidden');
        }
      });
    } else {
      items.forEach(item => item.classList.remove('hidden'));
    }
  }

  // Toggle: clicking active pill clears filter
  document.querySelectorAll('.tag-nav a').forEach(pill => {
    pill.addEventListener('click', (e) => {
      if (pill.classList.contains('active')) {
        e.preventDefault();
        window.location.hash = '';
        filterPieces();
      }
    });
  });

  filterPieces();
  window.addEventListener('hashchange', filterPieces);
</script>
